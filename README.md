# SparkFun Qwiic OTOS Driver (C for STM32 HAL)


## 📝 Project Description

This library is a **C driver implementation** for the **SparkFun Qwiic Optical Tracking Odometry Sensor (OTOS)**, specifically designed for **STM32 microcontrollers** using the **HAL (Hardware Abstraction Layer) Libraries**. It provides a clean, modular, and efficient interface for interacting with the OTOS sensor's various capabilities, enabling seamless integration into any STM32-based embedded application.

## ✨ Features

The library provides functions to interact with the OTOS sensor across its full capabilities:

  * **Core Device Management:**
      * **Initialization (`OTOS_init`, `OTOS_begin_config`):** Set up the sensor instance and configure basic hardware parameters, including Product ID verification and default scalar settings.
      * **Reset Tracking (`OTOS_resetTracking`):** Reset the sensor's internal odometry (position and heading) to zero.
      * **Self-Test (`OTOS_selfTest`):** Run internal diagnostics to verify sensor functionality.
      * **Status (`OTOS_getStatus`):** Read sensor warnings (e.g., tilt, unreliable tracking) and fatal errors.
      * **Version Info (`OTOS_getVersionInfo`):** Retrieve hardware and firmware versions.
  * **Odometry Data Acquisition:**
      * **Position (`OTOS_getPosition`):** Get linear position (X, Y in Meters) and angular position (Heading in Radians).
      * **Velocity (`OTOS_getVelocity`):** Get linear velocity (X, Y in Meters/second) and angular velocity (Heading in Radians/second).
      * **Acceleration (`OTOS_getAcceleration`):** Get linear acceleration (X, Y in Meters/second squared) and angular acceleration (Heading in Radians/second squared).
  * **Odometry Configuration:**
      * **Signal Processing (`OTOS_setSignalProcessingConfig`):** Adjust internal filtering parameters (e.g., enable/disable accelerometer, rotation compensation, lookup table).
      * **Scales (`OTOS_setLinearScalar`, `OTOS_setAngularScalar`):** Fine-tune linear and angular measurement scaling factors.
      * **IMU Calibration (`OTOS_calibrateImu`):** Perform IMU calibration to remove offsets.
      * **Position Setting (`OTOS_setPosition`):** Set the sensor's current position to an arbitrary (X, Y, Heading) value.
      * **Offset Setting (`OTOS_setOffset`):** Configure a fixed offset for the sensor's reported position.
  * **Conversion Utilities:**
      * Provides explicit functions for converting standard output units (Meters, Radians) to alternative units:
          * Meters to Centimeters (`OTOS_convertLinear_m_to_cm`)
          * Meters to Inches (`OTOS_convertLinear_m_to_inch`)
          * Radians to Degrees (`OTOS_convertAngular_rad_to_deg`)
      * Basic angle conversions (`OTOS_degreesToRadians`, `OTOS_radiansToDegrees`).

## 🛠️ Hardware & Software Compatibility

  * **Microcontroller:** STM32H7xx Series (e.g., STM32H743VIT6) or any STM32 microcontroller with properly configured I2C and UART peripherals.
  * **Sensor:** SparkFun Qwiic Optical Tracking Odometry Sensor (OTOS).
  * **IDE:** STM32CubeIDE (recommended) or any compatible ARM GCC toolchain.
  * **Libraries:** STM32 HAL Libraries.

## 🚀 Installation & Usage Guide

### 1\. STM32CubeIDE Project Setup

1.  **Create a New STM32 Project:** Open STM32CubeIDE, create a new project for your specific STM32 microcontroller.
2.  **Configure Peripherals in `.ioc`:**
      * **I2C (for OTOS):** Activate `I2C` mode. Assign SDA and SCL pins (e.g., PB7 and PB6).
      * **Generate Code:** Save the configuration and click `Project -> Generate Code`.

### 2\. Integrate OTOS Library Files

1.  **Copy Source Files:**
      * Copy `otos.h` into your project's `Core/Inc` folder.
      * Copy `otos.c` into your project's `Core/Src` folder.
2.  **Add Include Path:** Ensure `Core/Inc` is included in your project's *include paths* (`Project Properties -> C/C++ General -> Paths and Symbols -> Includes`).

### 3\. Basic Usage Pattern (in your `main.c` or application code)

Your application's `main.c` file will orchestrate the setup and data acquisition.

1.  **Declare Sensor Instance:**

    ```c
    #include "otos.h"
    // ... (other includes) ...

    QwiicOTOS myOtosSensor; // Declare your sensor instance
    // Declare structs for output data
    OTOS_LinearPosition_t linearPos_m;
    OTOS_AngularPosition_t angularPos_rad;
    OTOS_Velocity_t velocity_ms;
    // ... (other variables for conversions, status, etc.) ...
    ```

2.  **Sensor Initialization Flow (in `main()` function):**
    Follow these steps in sequence in your `main()` function's setup part:

    ```c
    // main.c
    // ... (HAL System & Peripheral Initialization, generated by CubeMX) ...

    // 1. Initialize the OTOS sensor instance (software object)
    if (!OTOS_init(&myOtosSensor, &hi2c1)) { // Pass address of your I2C handle
        // Handle error: e.g., printf("ERROR: OTOS instance init failed!"); while(1);
    }

    // 2. Configure the physical OTOS sensor hardware (verifies connection, sets defaults)
    if (!OTOS_begin_config(&myOtosSensor)) { 
        // Handle error: e.g., printf("ERROR: OTOS hardware config failed!"); while(1);
    }

    // 3. (Optional) Set specific Signal Processing parameters (overrides default from begin_config)
    sfe_otos_signal_process_config_t spConfig = {0};
    spConfig.enRot = false; // Example: disable internal rotation for local X/Y
    spConfig.enAcc = true;
    spConfig.enLut = true;
    spConfig.enVar = true;
    if (!OTOS_setSignalProcessingConfig(&myOtosSensor, spConfig)) { /* handle warning/error */ }

    // 4. (Optional) Set custom Linear/Angular Scalars
    // if (!OTOS_setLinearScalar(&myOtosSensor, 0.97805413847f)) { /* handle warning/error */ }
    // if (!OTOS_setAngularScalar(&myOtosSensor, 1.01f)) { /* handle warning/error */ }

    // 5. (Important) Calibrate IMU (Sensor must be perfectly still during this call!)
    if (!OTOS_calibrateImu(&myOtosSensor, 255, true)) { // 255 samples, wait until done
        // Handle warning/error
    }

    // 6. (Important) Reset Tracking
    OTOS_resetTracking(&myOtosSensor); // Resets position to (0,0,0)

    // 7. (Optional) Set initial position offset
    // if (!OTOS_setOffset(&myOtosSensor, 5.0f, -2.5f, 15.0f)) { /* handle warning/error */ } // X/Y in CM, H in Degrees

    // 8. (Optional) Set initial absolute position (if overriding sensor's (0,0,0))
    // if (!OTOS_setPosition(&myOtosSensor, 1.0f, 2.0f, OTOS_degreesToRadians(90.0f))) { /* handle warning/error */ } // X/Y in Meters, H in Radians
    ```

3.  **Main Application Loop (in `while(1)`):**
    In your `while(1)` loop, you will repeatedly read data and perform actions.

    ```c
    // main.c
    while (1) {
        // 1. Get Position Data (Standard: Meters, Radians)
        if (OTOS_getPosition(&myOtosSensor, &linearPos_m, &angularPos_rad)) {
            // Data is now in linearPos_m (x_m, y_m) and angularPos_rad (h_rad)

            // 2. Convert to other units for display or specific calculations
            OTOS_LinearPosition_CM_t linearPos_cm;
            OTOS_AngularPosition_Deg_t angularPos_deg;
            OTOS_convertLinear_m_to_cm(&linearPos_m, &linearPos_cm);
            OTOS_convertAngular_rad_to_deg(&angularPos_rad, &angularPos_deg);

            // Print example (using converted data)
            printf("Pos: X=%.2f cm, Y=%.2f cm, H=%.2f deg\r\n", 
                   linearPos_cm.x_cm, linearPos_cm.y_cm, angularPos_deg.h_deg);
            
            // 3. (Optional) Get Velocity, Acceleration, Standard Deviations
            // OTOS_Velocity_t velocity_m_s;
            // if (OTOS_getVelocity(&myOtosSensor, &velocity_m_s)) { /* ... */ }
            // OTOS_PosStdDev_t pos_std_dev;
            // if (OTOS_getPosStdDev(&myOtosSensor, &pos_std_dev)) { /* ... */ }

            // 4. (Optional) Get Sensor Status
            // sfe_otos_status_t sensorStatus;
            // if (OTOS_getStatus(&myOtosSensor, &sensorStatus)) { /* ... check status bits ... */ }

        } else {
            printf("ERROR: Failed to read OTOS position.\r\n");
        }

        HAL_Delay(500); // Adjust delay based on your application's needs
    }
    ```

## 📚 API Reference

For detailed API documentation, including all parameters, return values, and descriptions for each function and structure, you can generate the documentation using **Doxygen**. Ensure you have Doxygen installed and run it on your project's `otos.h` and `otos.c` files.

